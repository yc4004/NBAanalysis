# Results

```{r include=FALSE}
library(tidyverse)
library(ggplot2)
library(GGally)
library(vcd)
library(RColorBrewer)
library(ggalluvial)
library(parcoords)
library(pander)
```

```{r}
shot_data = read_csv("shotchartdetail.csv")
```


In this chapter, we will our process to come up with the answers and our conclusions to each of the questions we proposed in the introduction section. Here are our questions proposed in the introduction chapter:

1. (On team level)
What is the difference between teams on their shooting preference? Does the preference change period by period? Does their field goal percentage related to the preference? 

2. (On individual player level)
Whether Russ Westbrook (Guard) has different shooting behavior (the shooting count and shot probability on different areas on the field) in different periods of the game? What about LeBron James (Forward)? Is LeBron’s shooting behavior similar to Russ ’s in different periods of the game?

Note that in the following analysis, we need to plot the NBA court to visualize the shooting data. The code for drawing the court is adapted from https://github.com/toddwschneider/ballr, and the court graph is as follows:

```{r}
circle_points = function(center = c(0, 0), radius = 1, npoints = 360) {
  angles = seq(0, 2 * pi, length.out = npoints)
  return(data_frame(x = center[1] + radius * cos(angles),
                    y = center[2] + radius * sin(angles)))
}

width = 50
height = 94 / 2
key_height = 19
inner_key_width = 12
outer_key_width = 16
backboard_width = 6
backboard_offset = 4
neck_length = 0.5
hoop_radius = 0.75
hoop_center_y = backboard_offset + neck_length + hoop_radius
three_point_radius = 23.75
three_point_side_radius = 22
three_point_side_height = 14
court_themes = list(
  light = list(
    court = 'floralwhite',
    lines = '#999999',
    text = '#222222',
    made = '#00bfc4',
    missed = '#f8766d',
    hex_border_size = 1,
    hex_border_color = "#000000"
  ),
  dark = list(
    court = '#000004',
    lines = '#999999',
    text = '#f0f0f0',
    made = '#00bfc4',
    missed = '#f8766d',
    hex_border_size = 0,
    hex_border_color = "#000000"
  )
)


plot_court = function(court_theme = court_themes$light, use_short_three = FALSE) {
  if (use_short_three) {
    three_point_radius = 22
    three_point_side_height = 0
  }
  
  court_points = tibble(
    x = c(width / 2, width / 2, -width / 2, -width / 2, width / 2),
    y = c(height, 0, 0, height, height),
    desc = "perimeter"
  )
  
  court_points = bind_rows(court_points , tibble(
    x = c(outer_key_width / 2, outer_key_width / 2, -outer_key_width / 2, -outer_key_width / 2),
    y = c(0, key_height, key_height, 0),
    desc = "outer_key"
  ))
  
  court_points = bind_rows(court_points , tibble(
    x = c(-backboard_width / 2, backboard_width / 2),
    y = c(backboard_offset, backboard_offset),
    desc = "backboard"
  ))
  
  court_points = bind_rows(court_points , tibble(
    x = c(0, 0), y = c(backboard_offset, backboard_offset + neck_length), desc = "neck"
  ))
  
  foul_circle = circle_points(center = c(0, key_height), radius = inner_key_width / 2)
  
  foul_circle_top = filter(foul_circle, y > key_height) %>%
    mutate(desc = "foul_circle_top")
  
  foul_circle_bottom = filter(foul_circle, y < key_height) %>%
    mutate(
      angle = atan((y - key_height) / x) * 180 / pi,
      angle_group = floor((angle - 5.625) / 11.25),
      desc = paste0("foul_circle_bottom_", angle_group)
    ) %>%
    filter(angle_group %% 2 == 0) %>%
    select(x, y, desc)
  
  hoop = circle_points(center = c(0, hoop_center_y), radius = hoop_radius) %>%
    mutate(desc = "hoop")
  
  restricted = circle_points(center = c(0, hoop_center_y), radius = 4) %>%
    filter(y >= hoop_center_y) %>%
    mutate(desc = "restricted")
  
  three_point_circle = circle_points(center = c(0, hoop_center_y), radius = three_point_radius) %>%
    filter(y >= three_point_side_height, y >= hoop_center_y)
  
  three_point_line = tibble(
    x = c(three_point_side_radius, three_point_side_radius, three_point_circle$x, -three_point_side_radius, -three_point_side_radius),
    y = c(0, three_point_side_height, three_point_circle$y, three_point_side_height, 0),
    desc = "three_point_line"
  )
  
  court_points = bind_rows(
    court_points,
    foul_circle_top,
    foul_circle_bottom,
    hoop,
    restricted,
    three_point_line
  )
  
  
  court_points <- court_points
  
  ggplot() +
    geom_path(
      data = court_points,
      aes(x = x, y = y, group = desc),
      color = court_theme$lines
    ) +
    coord_fixed(ylim = c(0, 45), xlim = c(-25, 25)) +
    theme_minimal(base_size = 22) +
    theme(
      text = element_text(color = court_theme$text),
      plot.background = element_rect(fill = 'floralwhite', color = 'floralwhite'),
      panel.background = element_rect(fill = court_theme$court, color = court_theme$court),
      panel.grid = element_blank(),
      panel.border = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      legend.background = element_rect(fill = court_theme$court, color = court_theme$court),
      legend.margin = margin(-1, 0, 0, 0, unit = "lines"),
      legend.position = "bottom",
      legend.key = element_blank(),
      legend.text = element_text(size = rel(1.0))
    )
}

plot_court(court_themes$light)
```

## Team Shooting Pattern Analysis

Firstly, to get a general understanding of how many 2-point and 3-point shots each team attempted for season 2020-21, we create a Cleveland Dot Plot as follows:

```{r}
shot_data %>%
  select(team_name, shot_type) %>%
  group_by(team_name,shot_type) %>%
  summarize(n = n(),.groups = 'drop') %>%
  pivot_wider(values_from = n, names_from = shot_type) %>%
  rename_all(make.names) %>%
  rename(two_point_shots = X2PT.Field.Goal, three_point_shots = X3PT.Field.Goal) %>%
  mutate(shots_sum = two_point_shots+ three_point_shots) %>% # calculate total
  arrange(desc(shots_sum)) %>% # order by total
  pivot_longer(cols = c("two_point_shots", "three_point_shots","shots_sum")) %>% # tidy the data
  ggplot(aes(x = value, y = reorder(team_name, value), color = name))+
  geom_point()+
  theme_linedraw()+ 
  labs(title = "2-point and 3-point Total Shots for Each Team", x = "count", y = "Team Name")
```

From the Cleveland Dot Plot, we can see that the total shots made by each team for the entire season doesn't vary a lot, ranging from around 6000 to 6500. However, for different teams, they have totally different preference for 2-point shots and 3-point shots, which may be resulted by types of players in that team. 

For example, Utah Jazz has almost same counts for 2-point shots and 3-point shots with the most 3-point shots in the league. On the contrary, San Antonio Spurs has least count of 3-point shots and most count of 2-point shots in the league.

After generally seeing the preference of different teams, now we can explore the movement of preference for 2-point shots and 3-point shots period by period. To see the preference change, here we calculate the percentage of 3-point shots among all shots made in each period for each team. If the percentage increase, it means that the team prefer to make more 3-point shots.

```{r}
getPalette = colorRampPalette(brewer.pal(9, "Set1"))

period_shots <- shot_data %>%
  filter(period <= 4) %>%
  select(team_name, shot_type, period) %>%
  mutate(period = factor(period)) %>%
  group_by(team_name, shot_type, period) %>%
  summarize(n = n(),.groups = 'drop') %>%
  pivot_wider(names_from = shot_type, values_from = n) %>%
  rename_all(make.names) %>%
  mutate(p = X3PT.Field.Goal/(X3PT.Field.Goal + X2PT.Field.Goal)) %>%
  mutate(three_point_percentage_cut = cut(p, breaks=c(-Inf,0.3,0.35,0.4,0.45,0.5,Inf), 
                            labels=c("<30%", "30%-35%", "35%-40%", "40%-45%","45%-50%","50%+"))) %>%
  mutate(three_point_percentage_cut = as.character(three_point_percentage_cut)) %>% 
  select(-c(X2PT.Field.Goal,X3PT.Field.Goal,p)) %>%
  pivot_wider(names_from = period, values_from = three_point_percentage_cut) 

colnames(period_shots) <- c("Name", "Period1", "Period2", "Period3","Period4")

period_shots%>%
  ggplot(aes( axis1 = Period1, axis2 = Period2, axis3 = Period3, axis4 = Period4))+
  geom_alluvium(aes(fill = Name), width = 1/12)+
  geom_stratum(width = 1/12, fill = "grey80", color = "dark grey")+
  geom_label(stat="stratum",
             aes(label = after_stat(stratum)))+
  ggtitle("Alluvial Diagram of 3-point Shots Percentage Change")+
  theme_void()+
  scale_fill_manual(values = getPalette(30))+
  theme(legend.position="bottom",legend.title = element_text(size=4), legend.text = element_text(size=4))

```

*(Here Each color represents one team. The percentage represent the percentage of 3-point shots of total number of shots attempted each period. The first axis means 1st period, and so on.)*

From the graph we can see that, indeed, most of the teams will have different preference for 2-point and 3-point shots regarding to different periods of a game. For example, Brooklyn Nets experienced largest change in the percentage of 3-point shots among other teams: at 1st period, it has percentage between 40% and 35%, and during the 2nd period, the percentage decreased to 35% - 40%. Then during 3rd period, the percentage increased to 40%-45% and finally reached 45%-50% at the 4th period.

A general trend is that, as the game approaches to 4th period, teams tend to make more 3-point shots compared to their performance in 1st period.

After getting a general understanding of types and shots attempted for each team, now we want to focus on the Field Goal Percentage ($\frac{\text{ total shots made}}{\text{total shots attempted}}$).

Here we will use diverging bar chart to compare the Field Goal % for 2-point and 3-point shots for each team, ordering by Field Goal % for 3-point shots:
```{r}
FG_shot_type <- shot_data %>%
  select(team_name, shot_type,shot_attempted_flag,shot_made_flag) %>%
  group_by(team_name,shot_type) %>%
  summarize(attempts = sum(shot_attempted_flag),
            goals = sum(shot_made_flag), .groups = 'drop') %>%
  mutate(FGp = (goals/attempts)*100) %>%
  select(team_name,shot_type,FGp) %>%
  pivot_wider(values_from = FGp, names_from = shot_type)

HH::likert(team_name~., FG_shot_type, positive.order = TRUE,
           main = "FG% for 2-point and 3-point Shots for Each Team", 
           xlab = "Percent", ylab = "Team Name")
```

From the plot, we can see that, generally, 3-point Field Goal is less than 2-point Field Goal, which makes sense because 3-point shots are harder to score regarding to the distance.

It is difficult to see if their is any relationship between the team's preference for 2-point or 3-point shots and the FG%. Based on our previous conclusion, Utah Jazz has the most number of 3-point shots attempted, and San Antonio Spurs were concluded as the team least preferring 3-point shots. However, their FG% for 3-point shots are neither highest or lowest in the league. This situation may be affected by the fact that, since the team prefer 3-point shots, so they make more, and they miss more, so the FG% decreases. 

## Individual Player Analysis
Here we will specially explore 

