--- 
title: "NBA Shooting Pattern Analysis"
author: "Anne Lin, Yanbing Chen"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

Basketball is a team sport in which the goal is to try to outscore the amount in a fixed amount of time. Points are scored (either 2 or 3 points) by putting the ball throw a hoop on one end of the court. An attempt at putting the ball throw the hoop is known as a "shot". If helpful, here are rules of basketball: https://en.wikipedia.org/wiki/Rules_of_basketball.

The National Basketball Association (NBA) is the professional basketball league in the United States and provides a nice website with many statistics gathered on teams and players in the league: https://www.nba.com/stats/.

As one of the most popular athletic leagues, NBA attracts elite players and these players represent the highest level of basketball in the world. However, the shooting behavior varies from player to player and even team to team. Therefore, intrigued by a passion for basketball and the abundance of data resources on the NBA website, we decided to implore the pattern of shooting behaviors in NBA for our final project and hope to take a small glance on what we are curious about through exploratory data analysis and visualization.

We propose the following questions to answer:

1. (On league level)

2. (On team level)
What are some differences between shooting behaviors preferences for each team? Does the preference change period by period? Does the preference corresponds to field goal percentage?

3. (On individual player level)
Whether Russ Westbrook (Guard) has different shooting behavior (the shooting count and shot probability on different areas on the field) in different periods of the game? What about LeBron James (Forward)? Is LeBron’s shooting behavior similar to Russ ’s in different periods of the game?

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

Note that there is no downloading option for the data on NBA official website, so we need to scrape the data from the official website https://www.nba.com/stats/ using `GET()` from `httr` library.

Since the data source is the NBA official website, it is considered reliable. 

## Detailed shots data
The scraping procedure for detailed shots data for 2020-21 Regular Season is as follows:

* For the detailed shooting data, we firstly land in the https://www.nba.com/stats/ webpage. Scrolling down, we can see a "Shotchart Search" section. Inputting one player's name, taking Stephen Curry during 2021-22 season as example, we can land in the page https://www.nba.com/stats/events/?flag=3&CFID=33&CFPARAMS=2021-22&PlayerID=201939&ContextMeasure=FGA&Season=2021-22&section=player&sct=hex. 

* In this page, we can see data with each row being a field goal that gives us information like the type of shot, whether it was successful, shot distance, etc. However, the exact location of the shot doesn't appear. 

* To access the detailed shots location data, we can right click on the webpage and select "Inspect" and navigate to the "Network" tab. Then we can find the `shotchartdetail` data (if not appear, refresh page). Once find it, right clicking it and open it in a new tab, so we can get the URL.

* After getting the URL, we can use the url to import the data on the webpage into our R studio using `GET()` function.

```{r}
library(tidyverse)
library(httr)
```

```{r GET_shot_detail}

headers = c(
  `Connection` = 'keep-alive',
  `Accept` = 'application/json, text/plain, */*',
  `x-nba-stats-token` = 'true',
  `X-NewRelic-ID` = 'VQECWF5UChAHUlNTBwgBVw==',
  `User-Agent` = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36',
  `x-nba-stats-origin` = 'stats',
  `Sec-Fetch-Site` = 'same-origin',
  `Sec-Fetch-Mode` = 'cors',
  `Referer` = 'https://stats.nba.com/players/leaguedashplayerbiostats/',
  `Accept-Encoding` = 'gzip, deflate, br',
  `Accept-Language` = 'en-US,en;q=0.9'
)

# define a function to grab shots data
fetch_shots = function(player_id, season, season_type) {
  
  # GET request
  request = GET(
    "http://stats.nba.com/stats/shotchartdetail",
    query = list(
      PlayerID = player_id, # specific id OR 0 for all players
      Season = season, # game season in format such as "2020-21"
      SeasonType = season_type, #"Regular Season" OR "PlayOff"
      PlayerPosition = "",
      ContextMeasure = "FGA",
      DateFrom = "",
      DateTo = "",
      GameID = "",
      GameSegment = "",
      LastNGames = 0,
      LeagueID = "00",
      Location = "",
      Month = 0,
      OpponentTeamID = 0,
      Outcome = "",
      Period = 0,
      Position = "",
      RookieYear = "",
      SeasonSegment = "",
      TeamID = 0,
      VsConference = "",
      VsDivision = ""
    ),
    add_headers(headers)
  )
  
  stop_for_status(request)
  
  # grab requested data
  data = content(request)
  
  # get the desired data
  raw_shots_data = data$resultSets[[1]]$rowSet
  col_names = tolower(as.character(data$resultSets[[1]]$headers))
  
  # preprocess raw data
  if (length(raw_shots_data) == 0) {
    shots = data.frame(
      matrix(nrow = 0, ncol = length(col_names))
    )
  } else {
    shots = data.frame(
      matrix(
        unlist(raw_shots_data),
        ncol = length(col_names),
        byrow = TRUE
      )
    )
  }
  
  shots = as_tibble(shots)
  names(shots) = col_names
  
  return(shots)
}

shotchartdetail = fetch_shots(0,"2020-21","Regular Season")
```

```{r write_data}
write.csv(shotchartdetail, "shotchartdetail.csv",row.names = FALSE)
```

After building the function to grab shots data using `GET()` and doing simple data preprocessing, our final shot data contains in total 24 columns and around 200,000 observations. The variables include player information (ID, name), team information (ID, name), game information (ID, date), and shot information (period, minutes and seconds remaining, whether shot successful, XY location, shot zone, shot area, etc.) All variables are in either string or integer format except date.








<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

```{r load_library} 
library(tidyverse)
library(readr)
```


```{r load_data}
shot_data = read_csv("shotchartdetail.csv")
```

For the detailed shots data, there are some categorical data which should be as factor with levels. For example, for `shot_zone_range` feature, the level of category should be "Less Than 8 ft.", "8-16 ft.", "16-24 ft.", "24+ ft.", and "Back Court Shot" based on the distance from the basket.

```{r}
shot_data <- shot_data %>%
  mutate(shot_zone_range = factor(shot_zone_range, levels = c("Less Than 8 ft.", "8-16 ft.", "16-24 ft.","24+ ft.","Back Court Shot"))) 
```

<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing Values

```{r include=FALSE}
library(pander)
library(knitr)
library(tidyverse)
library(hexbin)
library(jsonlite)
library(httr)
library(scales)
library(patchwork)
library(readr)
```

We will look at the missing pattern of detailed shots data for NBA Regular Season 2020-21. After getting the data out in the data sources portion, here we firstly have a look at the head of data: 

```{r data}
shot_data = read_csv("shotchartdetail_cleaned.csv")
head(shot_data,3)  %>% pander()
```

It seems that there is actually no missing values in our first 5 rows of data. To examine the whole dataset, we firstly count the total number of missing value:
```{r}
as_tibble(sum(is.na(shot_data))) %>% pander()
```

To further confirm our hypothesis that our dataset contains no missing data, we then draw a missing value plot:
```{r missing value plot, fig.align = 'center', fig.height = 5, fig.width = 7}
# Input: df: dataframe to plot missing value; 
#        percent: indicator whether to output percentage (FALSE: count, TRUE: percent)
missing_plots <- function(df, percent = TRUE){
  
  # determine the level of variable based on # of missing rows
  var_levels <- data.frame(count = colSums(is.na(df))) %>%
    rownames_to_column("variable") %>%
    arrange(desc(count),variable) %>%
    pull(variable)
  
  # get the missing patterns
  missing_patterns <- data.frame(is.na(df)) %>%
  group_by_all() %>%
  count(name = "count", sort = TRUE) %>%
  ungroup()
  
  main <- missing_patterns %>%
    select(-count) %>%
    rowid_to_column("index") %>%
    rowwise() %>% 
    mutate(complete_case = sum(c_across(-index))) %>%
    mutate(complete_case = ifelse(complete_case == 0,TRUE,FALSE)) %>% # find complete cases
    gather("variable","missing_pattern",- c(index, complete_case)) %>% # make data in long form
    ggplot(aes(x = factor(variable, levels = var_levels), 
               y=reorder(index,-index), 
               fill = missing_pattern, 
               alpha = complete_case)) +
    geom_tile(color = "white", lwd = 0.5, linetype = 1)+
    geom_text(aes(label=
                    ifelse(complete_case==TRUE 
                             & variable == var_levels[as.integer(length(colnames(df))/2)+1],
                             "Complete Cases", "")))+ # label "Complete Cases" in middle
    scale_fill_manual(values=c("grey","purple4"))+ # define fill color 
    scale_alpha_manual(values=c(0.5,1))+ # define alpha
    ylab("missing cases") + xlab("variables") + # define x,y title
    theme_classic()+ 
    theme(legend.position = "none") # remove legend
  
  
  upper_c <- data.frame(count = colSums(is.na(df))) %>%
    rownames_to_column("variable") %>%
    ggplot(aes(x = factor(variable, levels = var_levels), y = count))+
    geom_col(fill = "steelblue", alpha = 0.5)+
    ylab(ifelse(percent == TRUE, "% rows missing", "# rows missing")) +
    theme_bw()+
    theme(panel.grid.major.x = element_blank(), # only keep horizontal lines
          axis.title.x=element_blank()) # remove x-axis title
  
  upper_p <- data.frame(count = colSums(is.na(df))) %>%
    mutate(count = count/nrow(df)*100) %>%
    rownames_to_column("variable") %>%
    ggplot(aes(x = factor(variable, levels = var_levels), y = count))+
    geom_col(fill = "steelblue", alpha = 0.5)+
    ylab(ifelse(percent == TRUE, "% rows missing", "# rows missing")) +
    theme_bw()+
    theme(panel.grid.major.x = element_blank(), # only keep horizontal lines
          axis.title.x=element_blank()) # remove x-axis title
  
  left <- missing_patterns %>%
  rowid_to_column("index") %>%
  rowwise() %>% 
  mutate(complete_case = sum(c_across(-c(index,count)))) %>%
  mutate(complete_case = ifelse(complete_case == 0,TRUE,FALSE)) %>%
  select(index,count,complete_case) %>%
  mutate(count = ifelse(percent == TRUE, count/nrow(df)*100, count)) %>%
  ggplot(aes(x = reorder(index,-index), y = count, alpha = complete_case))+
  geom_col(fill = "steelblue")+
  scale_alpha_manual(values=c(0.5,1))+
  ylab(ifelse(percent == TRUE, "% rows", "# rows")) +
  theme_bw()+
  coord_flip()+
  theme(panel.grid.major.y = element_blank(), # only keep horizontal lines
        axis.title.y=element_blank(), # remove x-axis title
        legend.position = "none") 
  
  if (percent == TRUE) {
    return (upper_p+main+left+ plot_layout(design = c( area(1, 1, 1, 3),area(2, 1, 4, 3), area(2, 4, 4, 4)))+plot_annotation(title = "Missing Value Plot with Percent of Missing Value"))
  }else{
    return (upper_c+main+left+ plot_layout(design = c( area(1, 1, 1, 3),area(2, 1, 4, 3), area(2, 4, 4, 4)))+plot_annotation(title = "Missing Value Plot with Count of Missing Value"))
  }
}

missing_plots(shot_data, FALSE)
```

From the plot, we can see that all rows are "completed cases", and the total number of missing values for each variable is 0.

As expected, both results indicates that our dataset contains no missing data. Therefore, we can finally conclude that there is no missing data in our datase and proceed to next steps.



<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

```{r include=FALSE}
library(tidyverse)
library(ggplot2)
library(GGally)
library(vcd)
library(RColorBrewer)
library(ggalluvial)
#devtools::install_github("timelyportfolio/parcoords")
library(parcoords)
library(pander)
library(ggridges)
library(patchwork)
```

```{r}
shot_data = read_csv("shotchartdetail.csv")
```


In this chapter, we will our process to come up with the answers and our conclusions to each of the questions we proposed in the introduction section. Here are our questions proposed in the introduction chapter:

1. (On team level)
<<<<<<< HEAD
What is the distribution of the total number of shots made for all players in the entire season? What about shot probability? Is there any difference between shots attempted and goaled for different teams in different zones? What about differences between the home team and visiting team?
=======
What are some differences between shooting behaviors preferences for each team? Does the preference change period by period? Does the preference corresponds to field goal percentage? 
>>>>>>> d447ba33054c98d8b9d0681ba70ce4548229bb81

2. (On individual player level)
Whether Russ Westbrook (Guard) has different shooting behavior (the shooting count and shot probability on different areas on the field) in different periods of the game? What about LeBron James (Forward)? Is LeBron’s shooting behavior similar to Russ ’s in different periods of the game?

Note that in the following analysis, we need to plot the NBA court to visualize the shooting data. The code for drawing the court is adapted from https://github.com/toddwschneider/ballr, and the court graph is as follows:

```{r}
circle_points = function(center = c(0, 0), radius = 1, npoints = 360) {
  angles = seq(0, 2 * pi, length.out = npoints)
  return(data_frame(x = center[1] + radius * cos(angles),
                    y = center[2] + radius * sin(angles)))
}

width = 50
height = 94 / 2
key_height = 19
inner_key_width = 12
outer_key_width = 16
backboard_width = 6
backboard_offset = 4
neck_length = 0.5
hoop_radius = 0.75
hoop_center_y = backboard_offset + neck_length + hoop_radius
three_point_radius = 23.75
three_point_side_radius = 22
three_point_side_height = 14
court_themes = list(
  light = list(
    court = 'floralwhite',
    lines = '#999999',
    text = '#222222',
    made = '#00bfc4',
    missed = '#f8766d',
    hex_border_size = 1,
    hex_border_color = "#000000"
  ),
  dark = list(
    court = '#000004',
    lines = '#999999',
    text = '#f0f0f0',
    made = '#00bfc4',
    missed = '#f8766d',
    hex_border_size = 0,
    hex_border_color = "#000000"
  )
)


plot_court = function(court_theme = court_themes$light, use_short_three = FALSE) {
  if (use_short_three) {
    three_point_radius = 22
    three_point_side_height = 0
  }
  
  court_points = tibble(
    x = c(width / 2, width / 2, -width / 2, -width / 2, width / 2),
    y = c(height, 0, 0, height, height),
    desc = "perimeter"
  )
  
  court_points = bind_rows(court_points , tibble(
    x = c(outer_key_width / 2, outer_key_width / 2, -outer_key_width / 2, -outer_key_width / 2),
    y = c(0, key_height, key_height, 0),
    desc = "outer_key"
  ))
  
  court_points = bind_rows(court_points , tibble(
    x = c(-backboard_width / 2, backboard_width / 2),
    y = c(backboard_offset, backboard_offset),
    desc = "backboard"
  ))
  
  court_points = bind_rows(court_points , tibble(
    x = c(0, 0), y = c(backboard_offset, backboard_offset + neck_length), desc = "neck"
  ))
  
  foul_circle = circle_points(center = c(0, key_height), radius = inner_key_width / 2)
  
  foul_circle_top = filter(foul_circle, y > key_height) %>%
    mutate(desc = "foul_circle_top")
  
  foul_circle_bottom = filter(foul_circle, y < key_height) %>%
    mutate(
      angle = atan((y - key_height) / x) * 180 / pi,
      angle_group = floor((angle - 5.625) / 11.25),
      desc = paste0("foul_circle_bottom_", angle_group)
    ) %>%
    filter(angle_group %% 2 == 0) %>%
    select(x, y, desc)
  
  hoop = circle_points(center = c(0, hoop_center_y), radius = hoop_radius) %>%
    mutate(desc = "hoop")
  
  restricted = circle_points(center = c(0, hoop_center_y), radius = 4) %>%
    filter(y >= hoop_center_y) %>%
    mutate(desc = "restricted")
  
  three_point_circle = circle_points(center = c(0, hoop_center_y), radius = three_point_radius) %>%
    filter(y >= three_point_side_height, y >= hoop_center_y)
  
  three_point_line = tibble(
    x = c(three_point_side_radius, three_point_side_radius, three_point_circle$x, -three_point_side_radius, -three_point_side_radius),
    y = c(0, three_point_side_height, three_point_circle$y, three_point_side_height, 0),
    desc = "three_point_line"
  )
  
  court_points = bind_rows(
    court_points,
    foul_circle_top,
    foul_circle_bottom,
    hoop,
    restricted,
    three_point_line
  )
  
  
  court_points <- court_points
  
  ggplot() +
    geom_path(
      data = court_points,
      aes(x = x, y = y, group = desc),
      color = court_theme$lines
    ) +
    coord_fixed(ylim = c(0, 45), xlim = c(-25, 25)) +
    theme_minimal(base_size = 22) +
    theme(
      text = element_text(color = court_theme$text),
      plot.background = element_rect(fill = 'floralwhite', color = 'floralwhite'),
      panel.background = element_rect(fill = court_theme$court, color = court_theme$court),
      panel.grid = element_blank(),
      panel.border = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      legend.background = element_rect(fill = court_theme$court, color = court_theme$court),
      legend.margin = margin(-1, 0, 0, 0, unit = "lines"),
      legend.position = "bottom",
      legend.key = element_blank(),
      legend.text = element_text(size = rel(1.0))
    )
}

plot_court(court_themes$light)
```

## League Shooting Pattern Analysis

Firstly we will look at the distribution of shots made by the entire league.
```{r}
density_graph <- shot_data %>%
  ggplot(aes(x = shot_distance)) + 
  geom_histogram(aes(y = ..density..), bins = 25)+
  geom_density(aes(color = "density curve"))+ 
  labs(title = "Distribution of Shot Distance", x = "Shot Distance (in)", y = "Density")


density_ridges_zone <- shot_data %>% 
  ggplot(aes(x = shot_distance, y=shot_zone_basic)) +
  geom_density_ridges(alpha = .5) + 
  labs(title = "Ridgeline Plots of Shot Distance in Different Zones", x = "Shot Distance (in)", y = "Zone")

density_graph + density_ridges_zone + plot_layout(ncol=1)
```

From the density histogram, we can see that most shots are made around distance of 0 inch and 25 inches. According to the Ridgeline Plots, we can conclude that the shots made around 0 inch distance are in the restricted area, and the shots made around 25 inch distance are all kinds of 3-point shots.


## Team Shooting Pattern Analysis

One striking difference between teams in shooting pattern is the team's preference for 2-point and 3-point shots. Firstly, to get a general understanding of how many 2-point and 3-point shots each team attempted for season 2020-21, we create a Cleveland Dot Plot as follows:

```{r}
shot_data %>%
  select(team_name, shot_type) %>%
  group_by(team_name,shot_type) %>%
  summarize(n = n(),.groups = 'drop') %>%
  pivot_wider(values_from = n, names_from = shot_type) %>%
  rename_all(make.names) %>%
  rename(two_point_shots = X2PT.Field.Goal, three_point_shots = X3PT.Field.Goal) %>%
  mutate(shots_sum = two_point_shots+ three_point_shots) %>% # calculate total
  arrange(desc(shots_sum)) %>% # order by total
  pivot_longer(cols = c("two_point_shots", "three_point_shots","shots_sum")) %>% # tidy the data
  ggplot(aes(x = value, y = reorder(team_name, value), color = name))+
  geom_point()+
  theme_linedraw()+ 
  labs(title = "Cleveland Dot Plot for Attempted Shots Count for Each Team", x = "count", y = "Team Name")
```

<<<<<<< HEAD
From the Cleveland Dot Plot, we can see that the total shots made by each team for the entire season doesn't vary a lot, ranging from around 6000 to 6500. However, for different teams, they have totally different preference for 2-point shots and 3-point shots, which may be resulted by types of players in that team. 

For example, Utah Jazz has almost same counts for 2-point shots and 3-point shots with the most 3-point shots in the league. On the contrary, San Antonio Spurs has least count of 3-point shots and most count of 2-point shots in the league. We could guess that San Antonio Spurs doesn't have a lot of 3-point players in the team so they prefer goaling by 2-point shots.
=======
From the Cleveland Dot Plot, we can see that the total shots made by each team for the entire season doesn't vary a lot, ranging from around 6000 to 6500. However, for different teams, they have different preference for 2-point shots and 3-point shots. For example, Utah Jazz has almost same counts for 2-point shots and 3-point shots with the most 3-point shots in the league. On the contrary, San Antonio Spurs has least count of 3-point shots and most count of 2-point shots in the league. Therefore, we can conclude that teams vary significantly on their choice for making 2-point or 3-point shots.
>>>>>>> d447ba33054c98d8b9d0681ba70ce4548229bb81

After getting a general understanding of types and shots attempted for each team, now we want to focus on the Field Goal Percentage (total shots goaled/ total shots attempted). 

```{r}
# order teams based on total shot probability
order <- shot_data %>%
  select(team_name,shot_attempted_flag,shot_made_flag) %>%
  group_by(team_name) %>%
  summarize(attempts = sum(shot_attempted_flag),
            goals = sum(shot_made_flag)) %>%
  mutate(goal_prob = goals/attempts)  %>%
  arrange(desc(goal_prob)) %>%
  pull(team_name)

<<<<<<< HEAD
shot_data %>%
  select(team_name,shot_zone_range,shot_attempted_flag,shot_made_flag) %>%
  mutate(team_name = factor(team_name, levels = order)) %>%
  mutate(shot_zone_range = factor(shot_zone_range, levels = c("Less Than 8 ft.", "8-16 ft.", "16-24 ft.","24+ ft.","Back Court Shot"))) %>%
  group_by(team_name,shot_zone_range) %>%
  summarize(attempts = sum(shot_attempted_flag),
            goals = sum(shot_made_flag)) %>%
  mutate(goal_prob = goals/attempts)  %>%
  ggplot(aes(x = team_name, y = goal_prob, color = shot_zone_range, shape = shot_zone_range))+
  geom_point()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title = "Scatter Plot of Goal Probability for Each Team", x = "Team", y = "Goal%")
```

## Individual Player Analysis

### Shooting behavior of Stephen Curry
As a ground-breaking player, Stephen Curry showed the world how explosive his scoring ability was and he is making a NBA record of three pointers made while this project is getting done. Analyzing his shooting behavior would be a great angle to start.
=======
period_shots <- shot_data %>%
  filter(period <= 4) %>%
  select(team_name, shot_type, period) %>%
  mutate(period = factor(period)) %>%
  group_by(team_name, shot_type, period) %>%
  summarize(n = n(),.groups = 'drop') %>%
  pivot_wider(names_from = shot_type, values_from = n) %>%
  rename_all(make.names) %>%
  mutate(p = X3PT.Field.Goal/(X3PT.Field.Goal + X2PT.Field.Goal)) %>%
  mutate(three_point_percentage_cut = cut(p, breaks=c(-Inf,0.3,0.35,0.4,0.45,0.5,Inf), 
                            labels=c("<30%", "30%-35%", "35%-40%", "40%-45%","45%-50%","50%+"))) %>%
  mutate(three_point_percentage_cut = as.character(three_point_percentage_cut)) %>% 
  select(-c(X2PT.Field.Goal,X3PT.Field.Goal,p)) %>%
  pivot_wider(names_from = period, values_from = three_point_percentage_cut) 
  
colnames(period_shots) <- c("Name", "Period1", "Period2", "Period3","Period4")

period_shots%>%
  ggplot(aes( axis1 = Period1, axis2 = Period2, axis3 = Period3, axis4 = Period4))+
  geom_alluvium(aes(fill = Name), width = 1/12)+
  geom_stratum(width = 1/12, fill = "grey80", color = "dark grey")+
  geom_label(stat="stratum",
             aes(label = after_stat(stratum)))+
  ggtitle("Alluvial Diagram of 3-point Shots Percentage Change")+
  theme_void()+
  scale_fill_manual(values = getPalette(30))+
  theme(legend.position="bottom",legend.title = element_text(size=4), legend.text = element_text(size=4))
>>>>>>> d447ba33054c98d8b9d0681ba70ce4548229bb81

```{r}
shot_steph = fetch_shots(201939,"2020-21","Regular Season")
shot_lebron = fetch_shots(2544,"2020-21","Regular Season")
```

```{r}
library(ggplot2)
library(dplyr)
library(plyr)
library(tidyverse)
library(hexbin)
library(jsonlite)
library(httr)
library(scales)

percent_formatter = function(x) {
  scales::percent(x, accuracy = 1)
}

players_url = "http://stats.nba.com/stats/commonallplayers?LeagueID=00&Season=2019-20&IsOnlyCurrentSeason=0"

request_headers = c(
  `Connection` = 'keep-alive',
  `Accept` = 'application/json, text/plain, */*',
  `x-nba-stats-token` = 'true',
  `X-NewRelic-ID` = 'VQECWF5UChAHUlNTBwgBVw==',
  `User-Agent` = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36',
  `x-nba-stats-origin` = 'stats',
  `Sec-Fetch-Site` = 'same-origin',
  `Sec-Fetch-Mode` = 'cors',
  `Referer` = 'https://stats.nba.com/players/leaguedashplayerbiostats/',
  `Accept-Encoding` = 'gzip, deflate, br',
  `Accept-Language` = 'en-US,en;q=0.9'
)
request = GET(players_url, add_headers(request_headers))

players_data = fromJSON(content(request, as = "text"))
players = tbl_df(data.frame(players_data$resultSets$rowSet[[1]], stringsAsFactors = FALSE))
names(players) = tolower(players_data$resultSets$headers[[1]])

players = mutate(players,
                 person_id = as.numeric(person_id),
                 rosterstatus = as.logical(as.numeric(rosterstatus)),
                 from_year = as.numeric(from_year),
                 to_year = as.numeric(to_year),
                 team_id = as.numeric(team_id)
)

if (Sys.Date() <= as.Date("2017-10-20")) {
  players = mutate(players, to_year = pmin(to_year, 2016))
}

players$name = sapply(players$display_last_comma_first, function(s) {
  paste(rev(strsplit(s, ", ")[[1]]), collapse = " ")
})

first_year_of_data = 1996
last_year_of_data = max(players$to_year)
season_strings = paste(first_year_of_data:last_year_of_data,
                       substr(first_year_of_data:last_year_of_data + 1, 3, 4),
                       sep = "-")
names(season_strings) = first_year_of_data:last_year_of_data

available_players = filter(players, to_year >= first_year_of_data)

names_table = table(available_players$name)
dupe_names = names(names_table[which(names_table > 1)])

available_players$name[available_players$name %in% dupe_names] = paste(
  available_players$name[available_players$name %in% dupe_names],
  available_players$person_id[available_players$name %in% dupe_names]
)

available_players$lower_name = tolower(available_players$name)
available_players = arrange(available_players, lower_name)

find_player_by_name = function(n) {
  filter(available_players, lower_name == tolower(n))
}

find_player_id_by_name = function(n) {
  find_player_by_name(n)$person_id
}
```

```{r}
fetch_shots_by_player_id_and_season = function(player_id, season, season_type) {
  
  request = GET(
    "http://stats.nba.com/stats/shotchartdetail",
    query = list(
      PlayerID = player_id,
      Season = season,
      SeasonType = season_type,
      PlayerPosition = "",
      ContextMeasure = "FGA",
      DateFrom = "",
      DateTo = "",
      GameID = "",
      GameSegment = "",
      LastNGames = 0,
      LeagueID = "00",
      Location = "",
      Month = 0,
      OpponentTeamID = 0,
      Outcome = "",
      Period = 0,
      Position = "",
      RookieYear = "",
      SeasonSegment = "",
      TeamID = 0,
      VsConference = "",
      VsDivision = ""
    ),
    add_headers(request_headers)
  )
  
  stop_for_status(request)
  
  data = content(request)
  
  raw_shots_data = data$resultSets[[1]]$rowSet
  col_names = tolower(as.character(data$resultSets[[1]]$headers))
  
  if (length(raw_shots_data) == 0) {
    shots = data.frame(
      matrix(nrow = 0, ncol = length(col_names))
    )
  } else {
    shots = data.frame(
      matrix(
        unlist(raw_shots_data),
        ncol = length(col_names),
        byrow = TRUE
      )
    )
  }
  
  shots = tbl_df(shots)
  names(shots) = col_names
  
  shots = mutate(shots,
                 loc_x = as.numeric(as.character(loc_x)) / 10,
                 loc_y = as.numeric(as.character(loc_y)) / 10 + hoop_center_y,
                 shot_distance = as.numeric(as.character(shot_distance)),
                 shot_made_numeric = as.numeric(as.character(shot_made_flag)),
                 shot_made_flag = factor(shot_made_flag, levels = c("1", "0"), labels = c("made", "missed")),
                 shot_attempted_flag = as.numeric(as.character(shot_attempted_flag)),
                 shot_value = ifelse(tolower(shot_type) == "3pt field goal", 3, 2),
                 game_date = as.Date(game_date, format = "%Y%m%d")
  )
  
  raw_league_avg_data = data$resultSets[[2]]$rowSet
  league_avg_names = tolower(as.character(data$resultSets[[2]]$headers))
  league_averages = tbl_df(data.frame(
    matrix(unlist(raw_league_avg_data), ncol = length(league_avg_names), byrow = TRUE)
  ))
  names(league_averages) = league_avg_names
  league_averages = mutate(league_averages,
                           fga = as.numeric(as.character(fga)),
                           fgm = as.numeric(as.character(fgm)),
                           fg_pct = as.numeric(as.character(fg_pct)),
                           shot_value = ifelse(shot_zone_basic %in% c("Above the Break 3", "Backcourt", "Left Corner 3", "Right Corner 3"), 3, 2)
  )
  
  return(list(player = shots, league_averages = league_averages))
}
```

```{r}
hex_bounds <- function(x, binwidth) {
  c(
    plyr::round_any(min(x), binwidth, floor) - 1e-6,
    plyr::round_any(max(x), binwidth, ceiling) + 1e-6
  )
}

calculate_hex_coords = function(shots, binwidths) {
  xbnds = hex_bounds(shots$loc_x, binwidths[1])
  xbins = diff(xbnds) / binwidths[1]
  ybnds = hex_bounds(shots$loc_y, binwidths[2])
  ybins = diff(ybnds) / binwidths[2]
  
  hb = hexbin(
    x = shots$loc_x,
    y = shots$loc_y,
    xbins = xbins,
    xbnds = xbnds,
    ybnds = ybnds,
    shape = ybins / xbins,
    IDs = TRUE
  )
  
  shots = mutate(shots, hexbin_id = hb@cID)
  
  hexbin_stats = shots %>%
    group_by(hexbin_id) %>%
    dplyr::summarise(
      hex_attempts = n(),
      hex_pct = mean(shot_made_numeric),
      hex_points_scored = sum(shot_made_numeric * shot_value),
      hex_points_per_shot = mean(shot_made_numeric * shot_value)
    ) 
  
  hexbin_ids_to_zones = shots %>%
    group_by(hexbin_id, shot_zone_range, shot_zone_area) %>%
    dplyr::summarise(attempts = n()) %>%
    ungroup() %>%
    arrange(hexbin_id, desc(attempts)) %>%
    group_by(hexbin_id) %>%
    filter(row_number() == 1) %>%
    select(hexbin_id, shot_zone_range, shot_zone_area)
  
  hexbin_stats = inner_join(hexbin_stats, hexbin_ids_to_zones, by = "hexbin_id")
  
  # from hexbin package, see: https://github.com/edzer/hexbin
  sx = hb@xbins / diff(hb@xbnds)
  sy = (hb@xbins * hb@shape) / diff(hb@ybnds)
  dx = 1 / (2 * sx)
  dy = 1 / (2 * sqrt(3) * sy)
  origin_coords = hexcoords(dx, dy)
  
  hex_centers = hcell2xy(hb)
  
  hexbin_coords = bind_rows(lapply(1:hb@ncells, function(i) {
    data.frame(
      x = origin_coords$x + hex_centers$x[i],
      y = origin_coords$y + hex_centers$y[i],
      center_x = hex_centers$x[i],
      center_y = hex_centers$y[i],
      hexbin_id = hb@cell[i]
    )
  }))
  
  inner_join(hexbin_coords, hexbin_stats, by = "hexbin_id")
}


calculate_hexbins_from_shots = function(shots, league_averages, binwidths, min_radius_factor, fg_diff_limits, fg_pct_limits, pps_limits) {
  if (nrow(shots) == 0) {
    return(list())
  }
  
  grouped_shots = group_by(shots, shot_zone_range, shot_zone_area)
  
  zone_stats = grouped_shots %>%
    dplyr::summarise(
      zone_attempts = n(),
      zone_pct = mean(shot_made_numeric),
      zone_points_scored = sum(shot_made_numeric * shot_value),
      zone_points_per_shot = mean(shot_made_numeric * shot_value)
    )
  
  league_zone_stats = league_averages %>%
    group_by(shot_zone_range, shot_zone_area) %>%
    dplyr::summarise(league_pct = sum(fgm) / sum(fga))
  
  hex_data = calculate_hex_coords(shots, binwidths = binwidths)
  
  join_keys = c("shot_zone_area", "shot_zone_range")
  
  hex_data = hex_data %>%
    inner_join(zone_stats, by = join_keys) %>%
    inner_join(league_zone_stats, by = join_keys)
  
  max_hex_attempts = max(hex_data$hex_attempts)
  
  
  hex_data = mutate(hex_data,
                    radius_factor = min_radius_factor + (1 - min_radius_factor) * log(hex_attempts + 1) / log(max_hex_attempts + 1),
                    adj_x = center_x + radius_factor * (x - center_x),
                    adj_y = center_y + radius_factor * (y - center_y),
                    bounded_fg_diff = pmin(pmax(zone_pct - league_pct, fg_diff_limits[1]), fg_diff_limits[2]),
                    bounded_fg_pct = pmin(pmax(zone_pct, fg_pct_limits[1]), fg_pct_limits[2]),
                    bounded_points_per_shot = pmin(pmax(zone_points_per_shot, pps_limits[1]), pps_limits[2]))
  
  list(hex_data = hex_data, fg_diff_limits = fg_diff_limits, fg_pct_limits = fg_pct_limits, pps_limits = pps_limits)
  
}
```

```{r}
get_data <- function(id, seasons, season_type) {
  
  df <- fetch_shots_by_player_id_and_season(id, seasons, season_type)
  
  shots <- as.data.frame(df[1])
  league_averages <- as.data.frame(df[2])
  
  
  names(shots) <- sub(".*\\.", "", names(shots))
  names(league_averages) <- sub(".*\\.", "", names(league_averages))
  
  
  hex_data <- calculate_hexbins_from_shots(shots, league_averages,binwidths = c(1.5,1.5), min_radius_factor = .25, fg_diff_limits = c(-0.15, 0.15), fg_pct_limits = c(0.2, 0.7), pps_limits = c(0.5, 1.5))  
  
  df <- hex_data
  
  df <- as.data.frame(df[1])
  
  df$season <- seasons
  df$person_id <- id
  
  
  names(df) <- sub(".*\\.", "", names(df))
  
  return(df)
  
}
```

```{r}
shot_steph <- get_data(201939, "2020-21", "Regular Season")

library(prismatic)
library(extrafont)
library(cowplot)

p <- plot_court(court_themes$light) +
  geom_polygon(
    data = shot_steph,
    aes(
      x = adj_x,
      y = adj_y,
      group = hexbin_id, 
      fill = bounded_fg_diff, 
      color = after_scale(clr_darken(fill, .333))),
    size = .25) + 
  scale_x_continuous(limits = c(-27.5, 27.5)) + 
  scale_y_continuous(limits = c(0, 45)) +
  scale_fill_distiller(direction = -1, 
                       palette = "RdBu", 
                       limits = c(-.15, .15), 
                       breaks = seq(-.15, .15, .03),
                       labels = c("-15%", "-12%", "-9%", "-6%", "-3%", "0%", "+3%", "+6%", "+9%", "+12%", "+15%"),
                       "FG Percentage Points vs. League Average") +
  guides(fill=guide_legend(
    label.position = 'bottom', 
    title.position = 'top', 
    keywidth=.45,
    keyheight=.15, 
    default.unit="inch", 
    title.hjust = .5,
    title.vjust = 0,
    label.vjust = 3,
    nrow = 1))  +
  theme(text=element_text(size=14,  family="Gill Sans MT"), 
        legend.spacing.x = unit(0, 'cm'), 
        legend.title=element_text(size=12), 
        legend.text = element_text(size = rel(0.6)), 
        legend.margin=margin(-10,0,-1,0),
        legend.position = 'bottom',
        legend.box.margin=margin(-30,0,15,0), 
        plot.title = element_text(hjust = 0.5, vjust = -1, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 9, vjust = -.5), 
        plot.caption = element_text(face = "italic", size = 8), 
        plot.margin = margin(0, -5, 0, -5, "cm")) +
  labs(title = "Stephen Curry",
       subtitle = "2020-21 Regular Season")

ggdraw(p) + 
  theme(plot.background = element_rect(fill="floralwhite", color = NA))
```

This plot uses a graph of basketball court to visualize the performance of Stephen Curry at each point on the court and it divides the court to multiple hexagons. The size of hexagons represents the volume the player attempted in the hexagon area and larger size means more attempts. The color of hexagons indicate the shooting percentage of the player comparing to the average level of NBA. It is red if the player shoots above the leagu average and blue vice versa.

In the plot above, we could first notice that Stephen Curry trys most of his shots in the paint (a rectangle area nearest to the basket) and out of three-point line. This shooting behavior is a classical example of modern basketball: try less on mid-range shot. Another characteristic of his shooting is the range of his threes. We could even see multiple red hexagons even 7 feet further away from the three-point line, which makes it harder to guard him.

On the other hand, we could still see that Stephen has his weakness, which is left corner. His left-corner threes are deep blue so it would be a great strategy to limit him to shoot at that place. However, I think he is able to develope becasue he shoots very well on the other corner.


### Shooting pattern in playoffs of LeBron James

We could always say that games of regular season do not really matter because being a championship depends on the performance in playoffs. So many top players choose to take as many rest as they can in regual season so that they could save more energy for the playoffs. Therefore, it would be great if we can find some differences of shooting behavior in regular season and playoffs. As a die-hard Lakers fan, I would choose to analyze LeBron James.

```{r}
shot_lebron_regular <- get_data(2544, "2020-21", "Regular Season")

library(prismatic)
library(extrafont)
library(cowplot)

p1 <- plot_court(court_themes$light) +
  geom_polygon(
    data = shot_lebron_regular,
    aes(
      x = adj_x,
      y = adj_y,
      group = hexbin_id, 
      fill = bounded_fg_diff, 
      color = after_scale(clr_darken(fill, .333))),
    size = .25) + 
  scale_x_continuous(limits = c(-27.5, 27.5)) + 
  scale_y_continuous(limits = c(0, 45)) +
  scale_fill_distiller(direction = -1, 
                       palette = "RdBu", 
                       limits = c(-.15, .15), 
                       breaks = seq(-.15, .15, .03),
                       labels = c("-15%", "-12%", "-9%", "-6%", "-3%", "0%", "+3%", "+6%", "+9%", "+12%", "+15%"),
                       "FG Percentage Points vs. League Average") +
  guides(fill=guide_legend(
    label.position = 'bottom', 
    title.position = 'top', 
    keywidth=.3,
    keyheight=.15, 
    default.unit="inch", 
    title.hjust = .5,
    title.vjust = 0,
    label.vjust = 3,
    nrow = 1))  +
  theme(text=element_text(size=14,  family="Gill Sans MT"), 
        legend.spacing.x = unit(0, 'cm'), 
        legend.title=element_text(size=12), 
        legend.text = element_text(size = rel(0.6)), 
        legend.margin=margin(-10,0,-1,0),
        legend.position = 'bottom',
        legend.box.margin=margin(-30,0,15,0), 
        plot.title = element_text(hjust = 0.5, vjust = -1, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 9, vjust = -.5), 
        plot.caption = element_text(face = "italic", size = 8), 
        plot.margin = margin(0, -5, 0, -5, "cm")) +
  labs(title = "LeBron James",
       subtitle = "2020-21 Regular Season")

regular_lebron <- ggdraw(p1) + 
  theme(plot.background = element_rect(fill="floralwhite", color = NA))


shot_lebron_playoff <- get_data(2544, "2020-21", "Playoffs")

p2 <- plot_court(court_themes$light) +
  geom_polygon(
    data = shot_lebron_playoff,
    aes(
      x = adj_x,
      y = adj_y,
      group = hexbin_id, 
      fill = bounded_fg_diff, 
      color = after_scale(clr_darken(fill, .333))),
    size = .25) + 
  scale_x_continuous(limits = c(-27.5, 27.5)) + 
  scale_y_continuous(limits = c(0, 45)) +
  scale_fill_distiller(direction = -1, 
                       palette = "RdBu", 
                       limits = c(-.15, .15), 
                       breaks = seq(-.15, .15, .03),
                       labels = c("-15%", "-12%", "-9%", "-6%", "-3%", "0%", "+3%", "+6%", "+9%", "+12%", "+15%"),
                       "FG Percentage Points vs. League Average") +
  guides(fill=guide_legend(
    label.position = 'bottom', 
    title.position = 'top', 
    keywidth=.3,
    keyheight=.15, 
    default.unit="inch", 
    title.hjust = .5,
    title.vjust = 0,
    label.vjust = 3,
    nrow = 1))  +
  theme(text=element_text(size=14,  family="Gill Sans MT"), 
        legend.spacing.x = unit(0, 'cm'), 
        legend.title=element_text(size=12), 
        legend.text = element_text(size = rel(0.6)), 
        legend.margin=margin(-10,0,-1,0),
        legend.position = 'bottom',
        legend.box.margin=margin(-30,0,15,0), 
        plot.title = element_text(hjust = 0.5, vjust = -1, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 9, vjust = -.5), 
        plot.caption = element_text(face = "italic", size = 8), 
        plot.margin = margin(0, -5, 0, -5, "cm")) +
  labs(title = "LeBron James",
       subtitle = "2020-21 PlayOffs")

playoff_lebron <- ggdraw(p2) + 
  theme(plot.background = element_rect(fill="floralwhite", color = NA))


plot_grid(regular_lebron, playoff_lebron)
```

By looking at the regular season shot chart on the left, it is obvious that LeBron did fantastic in the paint, which shows that his advantage near the basketball still exists. In contrary, he also tried a lot mid range shots and threes but the results was not ideal, except that his shooting percentage on the left corner is extremely high, where by chance Stephen Curry was not good at.

Comparing the performance in regular season and playoffs, we could see that although LeBron James still did better than average in the semi-circle area under the basket, his shooting significantly declined in that area. It might be the reason why Lakers in this season did not make it to the finals. Moreover, he still behaved well on the left corner in playoffs than the other one so the defending strategy against LeBron should be opposite to Stephen Curry.

### Analysis on shooting behavior in different periods of LeBron James 

Every basketball game has four periods and athletes would get exhausted when game is getting to the end, so it is important to arrange the rest and the rush hour properly. Therefore, let us take a look at the shooting behavior of LeBron James in different periods and hope to find some special patterns in it.

```{r}
shot_lebron = fetch_shots(2544,"2020-21","Regular Season")
shot_lebron %>%
  filter(period!="5" & period!="6") %>%
  ggplot(aes(x = as.numeric(as.character(shot_distance)), group = period, fill = period)) +
  geom_density(alpha = 0.5) +
  theme(legend.position = c(0.9, 0.8)) +
  xlab("Shooting Distance")
```

Based on the plot, LeBron James prefers attacking the tim to shooting long-distance in the second period and among four periods it is last one that he attempted most threes. Therefore, there is one more defending policy against LeBron should be focusing more on his layups in the first half and his threes in the second half.


<<<<<<< HEAD

=======
It is difficult to see if the FG% for 2-point or 3-point corresponds to the team's preference. Based on our previous conclusion, Utah Jazz has the most number of 3-point shots attempted, and San Antonio Spurs were concluded as the team least preferring 3-point shots. However, the FG% for 3-point shots are not highest for Utah Jazz and not lowest for San Antonio Spurs. This situation may be affected by the fact that, since the team prefer 3-point shots, so they make more, and they miss more, so the FG% decreases.


<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component



<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

